name: release

# allow this workflow's GITHUB_TOKEN to read artifacts from other runs
permissions:
  contents: read
  actions: read

on:
  workflow_run:
    workflows: ["build-image"]
    types: [completed]

jobs:
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  stage:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment: stage

    steps:
      - uses: actions/checkout@v4            # ğŸ—„  bring repo into workspace

      - uses: actions/download-artifact@v4   # â˜ï¸  get tag.txt from build run
        with:
          name: image-tag
          path: .
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - run: echo "Tag is $(cat tag.txt)"     # ğŸ”  quick sanity check

      - uses: azure/login@v2                 # ğŸ”‘  Azure CLI login
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸš€ Deploy to stage
        run: |
          TAG=$(cat tag.txt)
          az deployment group create \
            -g ${{ secrets.STAGE_RG }} \
            -f infra/main.bicep \
            -p acrName=${{ secrets.ACR_NAME }} tag=$TAG stage=stage

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  prod-canary:
    needs: stage
    runs-on: ubuntu-latest
    environment: production

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: image-tag
          path: .
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - run: echo "Tag is $(cat tag.txt)"

      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ£ Create new revision (0 %)
        run: |
          TAG=$(cat tag.txt)
          az containerapp update \
            -n sentiment-api-prod \
            -g ${{ secrets.PROD_RG }} \
            --image ${{ secrets.ACR_LOGIN_SERVER }}/hf-api:$TAG \
            --revision-suffix $TAG \
            --ingress-traffic latest=0 current=100

      - name: ğŸ” Smoke test canary
        run: |
          ENDPOINT=$(az containerapp show -n sentiment-api-prod -g ${{ secrets.PROD_RG }} \
                     --query properties.configuration.ingress.fqdn -o tsv)
          curl --fail -X POST https://$ENDPOINT/predict \
               -H "Content-Type: application/json" \
               -d '{"text":"health probe"}'

      - name: â†—ï¸  Shift 10 % traffic
        run: |
          TAG=$(cat tag.txt)
          az containerapp ingress traffic set \
            -n sentiment-api-prod -g ${{ secrets.PROD_RG }} \
            --revision-weight $TAG=10 current=90

      - name: â±  Validate 30 min
        timeout-minutes: 30
        run: sleep 1800

      - name: âœ… Promote 100 %
        if: success()
        run: |
          TAG=$(cat tag.txt)
          az containerapp ingress traffic set \
            -n sentiment-api-prod -g ${{ secrets.PROD_RG }} \
            --revision-weight $TAG=100
